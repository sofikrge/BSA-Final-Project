import numpy as np
import matplotlib.pyplot as plt

def plot_correlogram_matrix(correlogram_results, neurons_data, binsize=0.001, limit=0.02):
    num_neurons = len(neurons_data)
    fig, axes = plt.subplots(num_neurons, num_neurons, figsize=(num_neurons * 3, num_neurons * 3))
    
    for i, neuron_i in enumerate(neurons_data):
        for j, neuron_j in enumerate(neurons_data):
            # Retrieve precomputed correlogram
            counts = correlogram_results[(i, j)]["counts"]
            bins = correlogram_results[(i, j)]["bins"]

            bin_centers = (bins[:-1] + bins[1:]) / 2

            # Handle single neuron case
            ax = axes[i, j] if num_neurons > 1 else axes

            # Plot histogram
            ax.bar(bin_centers, counts, width=np.diff(bins), align='center', color='b', alpha=0.7, edgecolor='k')
            ax.set_xlim(-limit, limit)
            ax.set_xticks([])
            ax.set_yticks([])

            # Labels for first row and first column
            if i == 0:
                ax.set_title(f"Neuron {j+1}")
            if j == 0:
                ax.set_ylabel(f"Neuron {i+1}")

    plt.tight_layout()
    plt.show()
